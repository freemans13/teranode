/*
Package validator implements Bitcoin SV transaction validation functionality.

This package provides comprehensive transaction validation for Bitcoin SV nodes,
including script verification, UTXO management, and policy enforcement. It supports
multiple script interpreters (GoBT, GoSDK, GoBDK) and implements the full Bitcoin
transaction validation ruleset.

Key features:
  - Transaction validation against Bitcoin consensus rules
  - UTXO spending and creation
  - Script verification using multiple interpreters
  - Policy enforcement
  - Block assembly integration
  - Kafka integration for transaction metadata

Usage:

	validator := NewTxValidator(logger, policy, params)
	err := validator.ValidateTransaction(tx, blockHeight, nil)
*/
package validator

import (
	"fmt"
	"reflect"
	"testing"

	"github.com/bsv-blockchain/go-bt/v2"
	"github.com/bsv-blockchain/go-bt/v2/bscript"
	"github.com/bsv-blockchain/go-chaincfg"
	"github.com/bsv-blockchain/teranode/settings"
	"github.com/bsv-blockchain/teranode/ulogger"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

type TestTx struct {
	TxID        string
	BlockHeight uint32
	ExtendedTx  string
	UTXOHeights []uint32
}

// https://github.com/bsv-blockchain/teranode/issues/1326
var testTxs = []TestTx{
	{
		TxID:        "1788b93e9b50d96de72171a28253f583b4f4dea1d32d93275b35a7cfbc3afacc",
		BlockHeight: 367886,
		ExtendedTx:  "010000000000000000ef01f80f63b70d76242a60f6a222e536f1383b6ac11ff69bb0b026871dfe8255ae5e010000006a47304402204dcc5d16184a0f5b73a56a9984de0156e60f486af4b9feb304c1e7a0bebeba50022029d2c4f7614438a3bb33b90ea6251aa760a2e6645068338faab2e65f7a54ca700121033ce8391ba0f2ffa4b39947920a28958b14569c382dab826e3e86253d6f2d6be6ffffffff906ca312000000001976a9143a570d7cd342bb8cf54193d2919d12f1b85f03cc88ac022000fc09000000001976a914dc1b13bfce97785162b14dc583947bc2e379eaa288ac501ea708000000001976a9144e70c86128dc5d236d7d79bd9e011e25ce9295aa88ac00000000",
		UTXOHeights: []uint32{367885},
	},
	{
		TxID:        "4c0ee136f712b1dfbe303e85a3b58e2af97ef9b59616eb6f552dfe252541c608",
		BlockHeight: 478558,
		ExtendedTx:  "010000000000000000ef27311c2a71da018a274fa5d2b18a9b85d72d5b7f32581dbc178302e483d9b2557401000000da0047304402200ffc68107e75fe4eb29c63ae68194e010657871597eb867832e9d2f06275af3e02201252b33175802f45c9ca1eaaa7b35768d709cfb48a6c2931fa1c905f9bda1ca001483045022100d25dff2ccb4896f5b9a058815d2ab67389b1f6ecabd54e44a22c4f58a818c40c02204b453d9f6c9e8f8ad4cc8483b5a2c17dff238e69a14519e0bee2c9b2d1a38bc3014752210242a5d58b808f3140bcef528392b92fe4206e0123552a18e1076b5a96139ffab621030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff9ff402000000000017a9149f8214254705b56fa453750ca9baede843d86f26874d013651efc7d06637d12b8cb536b80d82cc4822301ee054bf1af20948606d5601000000db00483045022100ff512e5714bddbb6b0e0a19d23ca5a9019b0a800a7d1a544369e574a6a0368a70220086f37a65b71b5f30f91ce9ab46d8d1b68c8c2309ec2a3a6a550163d1bc21de101483045022100b4c2dc2b1f10ec80cf35cd3f5037607100561992f7bf5831dcb422b03652c0d20220299c1017c41b1352f5269287e0fd521dbe1e7dde41e464143e3e94308226c2250147522102ee707bbbf2e3efce0f783ca32486448721df94a102893ebb4d9b53b0c124194c21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffafe400000000000017a914e6cfe3ef1e15dfafc072a7017fffd51b664581f0875f126566341e9ae8665ccc12738b7c43052bdbb7720523b4d7eb93b747588bd205000000da00473044022063f91ef7c0c644b86a18af4fb2daafb09ae06b04c2e9f2fb5d07383f1c23607302205d480216f44a4ee7ef1e978ee8fef1df2169dd38f989e1092076ab30f0995bf501483045022100ff9a5cef02fb31a795e720d19cfa30d533e35dcf20f867f1ad3a5529c363229302207851b5ab66ebacafc12cd1744199b5c66038b50af7c4270aac13de01aec5d5d80147522102b76a701c4de8edf4a31d52a261e61b9a64203164d5ebfcfd6d0e1210a5b3c24321030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff400009000000000017a9148799170be5802d69287aa8511a2aee594d23a4208767f62c6e85349937dc71bed3fd250a64b79d8844b2c8c3720e9edef2746aebec01000000da00473044022017478ed9dc3011d87cd8cbf2661ad9a79dcba04c12c1c11e1bae95ffdd0af8610220125cfbf199a28627804466f8cb65ec391a93fa0529ed0db9872353dd53f71bbe01483045022100c9d9fba5aba0394de26cfd6985dc57d1d667aaed8ce53992d9ff2dcbd3c90e7902206ed097828d88f3b1812bd7828b44891c5b9a1d25ac73e8ace04cf3cfe54e6e7a01475221032c32c22e7175bedb7ae416b2a6c4b1e128ff8d748a6bed3f343961bee2cf3aee21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffd41d47000000000017a9147ef68d00ccb82d1375c1542d2a87914c2c3295fd87c0e1fa75f4457c4e3303724a1e8cfb8b2b774778740a73efd73e344334702cbf00000000da004730440220411f7ea911d726d9d2018b67d026536f50473f471f43f77e4a2ffc73e323944f022032d670643c2f9048de21c83df481c22aa529e14f09a44e39725e673e5155dcc101483045022100df81282e1555ce6b7d03ad72c0d8516436d850ad14846d8ece048c107d9af945022001e8b898f49190532b5a1a707af403591c5a5f6e32325ddfcda67da175ef1490014752210393e69308eb7b3a7093ef61142adfe302014957b9239018a5f3acd761cc51715d21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff7f8247000000000017a9146b688305c25e0eaaf2433ec0ca35632d75c57e008707326ba30cf8f092b57c57b0b46e63b555f9eb46b37cf3b98b0a3b75afeb499a00000000da0047304402206f32e42cd6f4be51a849c034623cd008f74f17b0b1a94174be5ab65dba88a56d022016820422d5c5c5c3b7d4172b29845b8a64d480ea396b1ebfb2d254c6ff63e01401483045022100fa56f9f7a8e5fc0cdd472cddf41874f3b39586e1654f8dfd1d9f5677b5b39fc902203ccc5cdd5d1b7382ba9b4dd87f2867c2bf76b3d95da518cf43a96261efdb4d8c01475221035df2085fb768841baf5f85a8759f4cb530dcf04f9e47196e8bbde93f5e11684e21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffb0440b000000000017a91477749fc915c6b20182a6270e2509726e792e37ce873d56d9c2c62982c43156853bb5a92f8612c19d9d362f879ebbddb6f4d463eebe02000000d900473044022068bf8ea190fc74e97551d11bf54d9cc2ff417621a325dd2100e5a3e865a54d470220291d050a95056d1aa07934c2f7e3eb5aac604d27109b510545ba17d127e721690147304402201afc3d055a24cceaf0f9dc3fbfd4c7fc076c61d0c3931e71db9f00e14002090202200b58cc99c8a73faa823d1b69a65f7ecbcc3889aec753c5d4a76a48b49ee93b7801475221032e75899ddc9c5a4313fa6f4c51e5e7eb515a72eb4b79aa4ded2e9d904b1e99d921030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffa8cb0e000000000017a914c6f1e8e6641f24be8b12cefd7cc661a5e150868287e1551126cda98401898ca6e3514b3d76b68d680123d3b831afda3f0b1ea4ac5e01000000d9004730440220387ce1fe7280a16c23dccc178fe7bb3da0ff95bd20f671c02b13c6a42a09191902200b464b0bee4523b2195243bc62f4c1b36319ba75f2ec24ba7dd8b26d102ff9220147304402201499b91c33e14797d4132518bda529aed1119e8cc94d0e10c1b1ffdd169f875d022063001dfb89686330f21779158a1296e5e688d83a6f60a4d1e585dccc339c21520147522102806c47b3617ec30fd22a7cd6c2fe7c42d3e0b26193e8522f910c22584372677921030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff457547000000000017a914568c4d6fa0863fe1cf3bb8a85e179bbc6e107d0387e2c928d56e7cc566de3f720edfe9b14f58b57cf1861328ec05d4a7e90e269e5100000000da00473044022053ca2b306813f824ec983cebd729b7f777b615c54ba2203debd31deec1d91a360220761e48894f53b6d764e5c99ec657eb47fe9bb8782522c2dfe68f29632b04dd5801483045022100ef43a7d98adc02794fd389f6dcd17b078934fca9c67f416e2b5ecdcb60b50b97022049dcffc8fc530577304bb797e2f7e0bea8b60c68fee96559f969faef362c970b01475221028ae8f01d85b4f660669a26f22141ab978ce245e1956490d80f31590a1a433e7221030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aefffffffffe3a47000000000017a914c03e74b1230b617db2b2a1b1e383b0b0799b22c587a0dd05259bc681c29a92d6c52ca7b39583159f6486026a40b563a47ec8dfac6b0b000000d90047304402201769e09967bf33cde6f3da1605fee81eec1b0e81d3823ed091d17bf8bc4c73a6022058d08f954fb78327f4f042c0456e81a30264f61975c88c0b4ac666cf80d24f360147304402203493d069d3191d6a6188f0a3249099adf11eaa5b2b1a256fb328b3a21e6d1e8602201a53138f40da805dcbf2c2b8f417a8c39ec4986612a8789a40da38374bb85f530147522102bcdc4402a73543771514f5f17f87f61547ad9d6a7a1d6dec9e20f4ede7f8e58521030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aefffffffff06013000000000017a914c941d40aeddf94b96a3ca973fae9cb5f45320b8a878c280b0fc6bd7048116991d09c5dc143837426e3f9c291f6a5d659b7b8778c4207000000db00483045022100edb34b4303abcdfd602505bf333c12e868407787d614dec69483cf5793e2a2d702204ee3ef15d67ffc3cce0291fc4d4ae525ef598d20a8632fdbcf79d54e7f96c25501483045022100946ca606f534e70b0860f5a04fc868bdff66e4f60faabe9e9bc429240640c973022027b0e844d17f62b77a7dcba411d94ab23fbac475f1b5bdabb62ae9b07f28c9d50147522103d4964f23fafdc5da10850205ea1ea25bd0a63851af983392ac65ec655d3b8c8321030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff7fbc0e000000000017a914ad4832d125000c647a31fcd70c1f55137e52de5987aca0d15eb61149729749a6d4464c2800b27628a0dd1291028745192bf6ce8bd101000000d90047304402204e9fd5824cd0278e28e100aefc818c1bdb6650358b02ac6f855bb41f6346ea77022002ade252f02985087cf7e81f45bf0eed4959d192da64165460729a286d327ac4014730440220732f96be515b5ce85ceed325e7ca58697eba365d047a7d7c3eba2d271a47294d02202867820941764308de241d6d8c7cb20602ac8ff9c742a0024ca49415fdbafce4014752210225a5c19cd50e63dbc0863f71acf3d309d72bd7f7b5f57007d39e8fbc1315457e21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffa9d50e000000000017a9147a62fcc1e4444ce8ead78665e451dc4e3e20075f8795a3b3bbe6854ce0fc383e9495dd0768352b3824dfadc1481594e1db5ea192f701000000da00473044022029e6e8914b7b1d3444e23af2f24fcb60de4d7d7433f2ac0ebb0e43b09326c5ec02203126136eddc642f2c2dc7e092490d296fe684d656f12e92af96469f451aa33f701483045022100cd85e5de1a33ec61b51e608c9c1714960acfa6f6da431405a42e2257fe1b149f022039ee47fb0122c86e6dd4173f1f8b38ec7bf03fca5e82d0a086718698ff80493301475221032231cb45db8ed095d353198ca9fdeb40563ab7725cd5f31e17c755dc0ce1f2ef21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffb91aaf010000000017a9148824a7865f1083718f08c2202eb4e05950226ca687b8ff68bd5712057c745aa5b92dc0382924079a0f1aff75df507872e6b0ddfc2001000000d90047304402206cd27193bec9e064c35a8e039c004581222d8409c50ecb5bcb448a0a875c1bc502207bbb72e0a26013317a2cc5a01aa1c5a769391f6a2546676930ebbc020b252d4f0147304402207a814d8f292b4031e3674343d1e8a2745fe4f5e1d42b2ebe8d827377e8567d2202201fb36a7e4089d338a02cfdaf2a4714ba0b14d0595bc6a5b5274d1522e745aa1d0147522102f952b8eaa287b9d1c38422d8b0977f1f4832ba00bc27320bb5d5a985431a686321030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffe51d47000000000017a914d506958b9f6468428e0fbc1aa2c4a21866f3bf6287c35514f818dfb7e89a70553a6682288beaffffad9d1fa362dbf3bd69d747dccc00000000da00483045022100d077044a147ae925c5091cf6a190077d32318a1f74cc87fdf550c58aa65c070a02203d9f211d2cffbe30c5d403c43106362d7b5dc15615adaef8cac2396371a6ef36014730440220763460f6b2eef5c4f0d9c5acfc28b42e98a37f58ae9e543371be7d474bc1772d02202484ab4b94b1aa8d0d1eb94f340508005628b91d4ca6913d25e617d61527ad2d01475221026a37db2eb076f59aa252e2f230856006a27c18ac615ef999a667bc437100413421030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff79ae0e000000000017a91455cab6e5ec9d0f15f328fbc0bec871eddec9d7f787d67b3c72ae94db4e7c5e506773b83b6a0af009f55256f93f7529129cf8d8424f00000000d90047304402201b7d7ec950d55f5f0142cafd1d631a16e96093a41eda407178fe0ce287e40cbf02207fd05cca9125a97521ba96a6b3af04d193ad76467307cb2804fc499c1670ee4c0147304402201f236831705170d7c5cd55a23b9364e265e4cbce87f38b3c7fadbb674e6186bf02203c7bdaa92883dce78cd66d9b3dd3bd35ede4f6d0b2fd519193b9bcea3903857d0147522103839eaa42a61bda307168fa60685cd4f8a5b1ee41d88353e06bdca85fcd4efd7021030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff59ef55000000000017a914ba81def85a49ed5453850f10bf84e743ce8d77b6876dde8c6649070b30a3831eb3ab1711c21d9526f4a2dc373c06de5faae4b5090d00000000da00483045022100cc0e5d28d3b88be24c345857ef5f2aea9939e5a3c5f1dbe01dbc3735bf7374c502201ded166b72830a68b250c64692e7be5a4bc40f812142849105390e7223d2ffd40147304402201af57832bde52cf86720491ebd42e7716855c40ba7fdd36cf74fe225c088923a0220654fb5e9f0826d549d35e79982b5d881b3d5f94f0c2bf8b982422c0e6d17a2fa0147522103fab03382461996e0d65cf8568875b71819a1f552c88917fb8793e55730f2351921030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffdf7910000000000017a9142c09f949178afb32ec637999d99b176103fb8a0c87b09849ba0d80a79e97b9c3460b85820ae72f89ac2db562c19e40388e10ad38e101000000d90047304402205da6651b4adb55e15995a2882e1b3b7551c02fb29bdba715d8a9f714b43ea4f402206260c5997c1d5b911a2f7843c03a15399ae6c246a594f74c15d108772be9bf8c01473044022023dab7924fb0b9f8fe06e97641587eae87c073f99c79c16524f85d961315b3ac022062d4bfc5c5dce88de1e4f3956236b0914de32795dd2245e56d5a014d4b3646590147522103686831347a4d0d081c14fd170212e4bcb0c10405447fddb4a99ce7547963d97921030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff718546000000000017a914b9cb68f7629a19117e522076a7058b5a69df43ee87b692001f184fe79660d65ce0289298c0e9eda006bfee0ad89937d8759820246501000000da00483045022100d5b4eb6ce6994ab11ba5a8c3d3d0a892fd47ed45947392512da5c74c72be2a350220125d70b4e54d9f3e45baa2d66d0b9297776a4d6bf986b2fb6f4c0745e2b9b2b6014730440220086f7fcf323120a4d2ea1513551f5e570a87e2585145672a0bc9f41382d688d102205ee8919402a84affc6792a2228bd06b297ea146e2527f834f53128d76b0a99000147522102ef7c02bbea9200e358b4346483d8dcf75b1425958691a954280a2f9070d0287b21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff89f455000000000017a9149aef9354cbc5318b91e13f2f2bba7ed8e77a07da871c7619e8ba7096d56fbd5a864c31068a2d8e821bc48a066b19874ef60a9c416601000000da004830450221008953e25d265b6327b563b345774b2a2dd851f4baf72811326bbfb388fbc3c6e502207f10054eb6010678d3a7be6eebd245bff6e8d6f8a0fd6b1dd39206326e393856014730440220659ce2cd727493223e29652c58c3f74d839049933df57c1fae884a4a49c21bda02206efa272cc1c215852895f47acc26fbcb58c8a26d13a7ad74b25435247d522c230147522103ed197fd0ffb82ca238e9992139fe842512f9245aa4dcb3fe35f5c0316b253aea21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff23453e000000000017a9146b544ee9f555bf987bb6f1a867ec85b110cde32487413ca1b23cfb9d46852bf1d9254723f5be45ab86b8885d961f7436924085d25c01000000da00473044022061a89cea4f1b4dc6509d370e1d39d87faabff789b139d425d1cf7edcd301a5b602206e1ae14e36d7804e7aeb15b196fc054979a46ae490c3cbbb2ecb77bd864d20ad01483045022100971584b97c3f28269f24a75a66c832c68f724a0da3c9cfc5061668cc38180403022078a78a1a388d81d70ab6800d45683bd6d5c011ecb658d5a0d7726389b240232a014752210356200fa6583fdc9bf292759d261ffaadbe8023db4b9efbbfd13e4d2d6a1ce41d21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffad074b000000000017a9144ff6c18ef7b7544984e0faf0d5416b92d378caa7873fce9a1a4b74b703ec1a01570b18f4ecbd95b5507095963ccbd2f23d7580d59800000000da0048304502210099071918043713e482108784742dd09614d3b8e06fa8d4d8eaebc2534408aecf0220509f7152f436239875395965f4d7f397a4625035062ad5a046c6f97c317a253f0147304402202eac6ecea2d31a9e42566362b209413f91936ec45f839ff5339b1a9974c7db5d0220767a46764f3c18a3a0bd34e8eb214ba830a0cc57bde3706a4f0aa45ccf7997ed0147522102926e6918bdc7f2152c14754097357a4342636ca97181ad08f937e27c9912bb9521030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aefffffffff7c305000000000017a9148914ccdf0d0c4d0a36445c0c88dd275c270e15dd87957b2f7a7d814cd1b2aa0849283a6082bb6ba1fbcf19dc2190c528d1cda2cf0200000000d900473044022077b5e0a16650ff6ba9caf0ce15a73aaa875ad24911fefd655b7a2e2c50911d19022069521a51b156ea57b820535113c9b6370d5ebff6d507addb0d3de488289fa9030147304402202322f87a3897fcd2ecb15f0b10c03e0785de02ba6b72996845d1058b4c6ff6110220008ed63dc3ab5c1a45bef924b2ae147ce2e171ee161092d21ed684005bef259f01475221023de04de9de160a1bd0d32bc2fbf17c2547fcc33de856881c7ab922c338996c1121030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff1e740b000000000017a9147116c9c6d3bc6f589827b68dc777ec74c028a8dc87f63ecdfebc519966a3ceaf0921661a270049cd4ad80111d9d09048807f4a4ff900000000d9004730440220242ac13a2b35574a251916ddcc2f5a7b11881ecb878b459822ab9536bc75776102202931f6cfdc4cbb0ebb1182254fb8d2723f9acc984b90b5c76260d9a91581d4cb0147304402207c827514b9ad59c72e1fe3324d96ebbc0d750451272441f0bbbfacdd5f94e1e402206201dc86020877cc4578588f1c2ddd1d0496f7f30f8721245c7244b7641bee2301475221038ba31f61644ba43a6f96e6e4da0c06712a389a460ffa02c4100e3cfd947cc33321030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff25510e000000000017a914319c34dc34c12734bee505751fa15c5726a9f5cc877e16d14c9f7f57ba0eec1f1b7cdb707bd978fea4cbaf64ba40e8728fbb41dee800000000da00473044022037f39c5a430df0ca58f174858839f4338935a488f24c3b01084604ea4f0d11d302201c805c3617c4119869769837a4e1e27475e14df46def62fad101b4ed8fa627cc01483045022100cb877b9cba6c88efc29099b4efa5d75dc28a69248eaff8d753fdbb4d81bb226502206e0fa0d60fac6b89dea3d694722848dd2570984853845c2eb70bfc1f94bade6b0147522102d5421d381bb0e4f608e4e6db456ed2d6f924a5ed742169522c2be127374125d421030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff014345000000000017a9146f38fd10fa9172d276559c50ad096e5a36b33452877a44070f1e09af931b603cf27ce409a284207e90ad11f13ecf9ed1b926cf32d136000000d9004730440220238555dd26485db60ef7b6a2801f4ae00a69ed6ff2b376cfa7435a0d5d262a1a02200eb76dea3378594d9632d0d58e4a8ef69ecde34584d7d2f66cf2c3a8f1589f380147304402200145353856f2a8994cb6d397ded7c522e4148d83b9cb34f29f17f660a801b1be022078eaf57910066c20c97196e7fd9539e5a52bcfa79c9b671aa5205ad0eb8be5f90147522103cb616613dcc465a095f21aa1606542f1fac0100c7c5d6d933d6356522509988121030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff94cc38000000000017a914fbbf704fbdd1fc01723669621365835a1ad39d67873bf0f7d34babf33b43bd1d9122e401f6836c1ae6e5c012a94130752d2fdc794600000000da0047304402203bfbbaadc644873621b457ee5ffe7bef6f0662ce6063350deec3f3ad28b6019702201107abf593359dfea888f49b25df1ef604ab6163eae11edf5fb79fc551f4154701483045022100c24a73da08a0c8a094124c2ef795a9c5718ad8d92071b80bc7ff5ef1fd5273d302201dc6950f0c220a7058f64afec5f1a2cdde009bc64e81c6ca3547099763d366f501475221024e07097f7803c5196d737d9db0d95888972c4e7db31ed3ae0b3d60da5af9b51721030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffcc6d0e000000000017a914e5659c7e960874e933bed6ddffdef15943012c6887e7be3a71464ea4826e783463f9081573eb5968d3fa616e3d6970da9f1a39e16804000000db00483045022100c709d889ddf032489d6e980f760d4d1f325a948e98b0f3756411dd683844028202202cd0785aba9c4f7e4a4d282227227c0e2051a65956f5e8072ca6080b66989fb101483045022100a96963c345400920a2391877d1475557fcf2ab5df7dee82dc40bf04ccc61ad050220173c727eb2a3b018f3c71f53b27adfee4534b1bc8650908c245034219f9f44db0147522102982a443c93cdc080d61c44fdbc9271d0152fdf56900ff91b6e1c8711242642bb21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff56692b000000000017a91475bba96e52e1f182146c0a94a2bc4a50777945fe870956950c8b5f9cdaaa27e717f13f242242d4c54dabd4816dbee2bd36ff03d47900000000da0048304502210093efb6b9adbf985661623ab79acd34b5b483ac9c7c73972831a5a8558e66f8360220795921bbb85ee11e19116647c68f865f9d61e1412f96bd2a3f91e01cf433c03c0147304402202462bb5b8bbd34a6909f6697fbd44a3e00757c8178829291efb93ddd25463b2f02204c799d4305960785d3282d0f5d1803dc8b697504f6212bb417c6d88881dba6780147522102bec9b909c501dde8ecc1204a6be6f57224647a77e9600c8412b34b2ba3cf9a9121030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffa8bf45000000000017a914127b876bd8a33c55bd8505591e522715bef7cba1872bc59b7c89bde89f637962c4dc92f94d19223b5db9cfca137847f41de56bc41900000000db0048304502210095217b23593d7620b280a953ed88328428bb658a8a57a6110e27861e9675b202022014ff2feab81dcf1073884a16c9297954e2bcce67fa69a2ceaba046494114822401483045022100e029fa3a873cb9fc45147c4d96407b629d482d037602b828b18dec4b3171014102207b074465efe79e2f5b2592613a5a1ac4729e1999e27a36a3dc0671644016535a01475221032298055136fae85a44fc9948e159e7ff281e49fbf1bc01064f3c23775e1d62f721030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffb0630f000000000017a9141619db4d74e12e7e987f3680626e7d32a54cc92f879392bc679b9a572b447c67c3b3ab76e1f6704d67daff2a5faaff03063b18917256000000da00483045022100c48df0f4f2e959ab1a6e9f8ded5d9b806f64b8bdd0a9ae3a21800a818e8f153c02204eb06b47e4d09ae101cf9fed4810d40cf63dfce58b84106192484114d59a56ba01473044022010e5260ed3b3a57dd4c08f36fea69c5e83417ad2395d1d0c52ffbd5b8d8ee73d02202f953a3e9cd9d523d86ee7db9ced45489a3431e7cb738508d042c7a4ac421c470147522102cdbd8e641205776d6c08c9880991801d46352b34a7649f975f6dfb64bca501b921030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffd6020e000000000017a91400fb536153ce43a105d49a6203d6db7c97135a5f874a31d9754b4ac07a5a2d510938b83e8fac49c86bbb46a6d17b0e659d8dac88f400000000d90047304402206f3f91bf65904d89e067a5831a3e9d60d3a2dc62d68cda9584f0f8ae82caa57d02204a7abb14a3c3b0d503f683372a8459a23b8c94fbe42b32faff947d24313bf93d014730440220521771656b68236cc78fc437021458298dcd21afbe36bfdb7f18dc23044cde8202203ba820ebf2e73541028de68a8c808322b450be21f0ff63aa57ea19a01366b5d30147522103dd6063d704c991e2e0313c7044a9797199527819f6089913ae20aacf84c9684421030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffc2d10d000000000017a914156ec1d742154470e96306bcdc6ebc5a9c9273ac873e82f73517b33b36933aaa8b4538963d3f388a75e9bf06b481ffd2a25b7efcb401000000da0047304402206da70545aa30a0334a9bc7aa912743d86474db75692c3d50d4fa33042a524a47022002f5834ce2ada37ef49dd4d5f69684fff4b1843fcb538f0e392c2870f797334b014830450221009ded2b9e3e1834379089049930139ffe9bffb4b62a0d07e6cd0b98a81f1dbaeb02200cab99815c3f83b411ed7b0980ced8dca1e62c4616731979915a0995d67257bb01475221039b4f99721194a8371e2c7e6e16a9a0deb6b047c49c843638d2a650e8fc0aa9bc21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff955805000000000017a91400c2371c1613b8925d5783cce3aa5f69eb59fda1876685cb25ad9ec0e18243e5faa6487ea925028edbe53be6408a10bd2a20f73c5e00000000d90047304402207d59cd8e62b52f75489c90b46e6a3c48aa079e37334f1b090f91720138d5a22e022051df55ed74ffd04cb2d5e834d1d0dbb0707fab567a7ae4576e0b0ff8afb547350147304402206a3f2b9d0bba1d8fffe5fa54b598a5c5357bec1e260b71be15791170f79653e4022028303452f23e41f75b6fc66c3b5eafd29d19f6567fcd9fa22751c7def13f989f01475221022b0e42a5af93be9f167d9021035ba9327852b4148ab5f0df03f2bd822091785221030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffaf1a0e000000000017a914d054a3259e48c39a78630d9c7f079d192b1d599d875000cb837e1d64f0f2b5cb6d3550c0e5926b342a473096c5845f6a20e918dd3101000000da0047304402205447089408a153f27b837d367f85bc12b1193a823d95e4ea20b69530eb01ac8e022030dc19299cac46de67344a1653307a1690184409515d06009e550aeb5670f3b301483045022100f34706563e7a9542aa9a684dec118c3ec4a10920323582203c883117470db2a902201545d1f5b1429f9c238283632c2e892077315882a8da954b2a2d5e7843880dc50147522102aea0a420d8fca0d4a955e0440131c1e2d30db1a0dc65899b3b9781100d83f08b21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff9ba587000000000017a9148823f80a96b6a51748a6312423bcb690f0ce34e387ff4a3b7afec9fdf8a5d81084b017cd394982d9dabe546f532b88c9f9ec8ad57901000000d90047304402206cf06c343a1be3cd58b195f220678f7b20c793b79932b5c44c31d89404ce68ba022042db0e7892c84c12c528cc4e3575a81b9b313e1d7ae6f2646c007314db77ccf901473044022002a51ea9704eceae6ef36736cbe953c31490a4e1f1ea724b6c2b5d66971903d1022047533e58d1ee0494d595eab5f9258a79d978e5fb5dd4827334f26d20840ece5001475221023f3c06756e64f8cfb5beb051171a80f9ced199d401f7163142e9d1072fe4ed0d21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffb76b08000000000017a914ed6000f0fb1fd0ec3104a9eb47341776af556d0187e94220f5ee64f9d3806fc9007a797c6ca798324a05eeea8b583ea7bb76b3528f01000000db00483045022100be67dfb7232e91cbeb4819c18d1b65884205ef567503a2debc50f203fb002f3002205bab79db8918288a9d928682dc24729c73d40ffea492f4e33cc144fd4f1c946901483045022100e0beb8e17e70f92986ca7c8ba77704331dd30ba5f12c4f45ed2aa322bb893620022073d7ebe1dbe0ca839ad483dd9e6b06030a41489cb08cd05ba009bc9501ed2e890147522103da212114e975bc997c28d9073337a341ccd9c26a3d921f282730acc83eaf7cab21030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffffc8c742000000000017a9148ce353c06e8ee62a9eb00c3adea027e5a3e6679d8776a717305c58f18945455f925dacf4cd31527ced236d374299f4642c59e1573301000000d90047304402206f06d70d047b43efcf76fb2f085b2d833c2f55bf7be852dc1127dd0646c9bf3102205ad520b6824d12b8cb0216f886b1f9c0c011e32a9d0635a11e13e295e2b76f2d01473044022077ef04160049147717c6ebeec9754ed1b311e41c5cec4537c9017ba1ebf0a94802202ed2cd38bded01cacc589ba27fdfc42b4773eacea8ae4db2f3ab4383ccd7a0230147522103a576400db1e7d6922609694a95675b9457057b59990e5781303f7d04c32eb85821030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff114b0e000000000017a914a42b55999df32335249fe2a4191e560fa7d5480b8716ff93b5c963c7b75450edd1264fa04fb96f15ae11546916d892f2405729864906000000da00473044022043bddc0334de264394878142305ae823463b12dd573d227f24ce33946068ba3902205c1099e9dbc8b399e986e0564429b19375abf2768a023786416b6a8820569bba01483045022100cd861ce3b11ec8ea8a13c58d8a39140f5d474f7e180c8463427e2615fdcf67a7022058814a1bd64b157e4f61c02b9c7b711dc2e57f851516c0c504d28845d90caec4014752210328efa4de44c062b76d131928cf3a8c852573fdc5a9557f1fc0f85d826fec3bc121030caa37dbf3fe4c00720bf7ce224f5e4d309f5cbb440bb8b09c50d6e9efee991052aeffffffff283f0e000000000017a9149201ce36b939cdd953393b67ed6859c506fc3dd0870280924507000000001976a914e7bae170fd39f22fd03b34957d6b3ba0383f04a888acddc508000000000017a9149201ce36b939cdd953393b67ed6859c506fc3dd08700000000",
		UTXOHeights: []uint32{478217, 478255, 478269, 478278, 478278, 478284, 478307, 478309, 478310, 478320, 478332, 478348, 478367, 478378, 478383, 478387, 478388, 478390, 478398, 478400, 478406, 478411, 478423, 478423, 478424, 478432, 478435, 478436, 478440, 478451, 478457, 478462, 478465, 478470, 478491, 478506, 478512, 478536, 478552},
	},
	{
		TxID:        "e2ed7b133e9c7dc8933571579a9781541dfe3fca7eb0833491d8c5e2260c8d36",
		BlockHeight: 478558,
		ExtendedTx:  "010000000000000000ef0142ab684ea14ebbfb5214112c4a98b886befaa6a1185e99562d950055f5f1cce5010000006a47304402201ee83bf5a70fea00aa30d58fbd9bff40002d55e17298417414992a8672587b760220642532c7986f615532e22c57f5e25bcf03aa6d849bc8e6995522740d8759773c012102cc8e2d92beb730eadf3b584e87e1ca352e2b723cbf950e4b70301fefc1fd6987ffffffff84b00700000000001976a914d6ab498db8468ea50052a0fb85e755f53e8712b588ac025e7e0000000000001976a914984b956d4ced555c40b5f6d18c34ce77d1704fe588ac8f2b0700000000001976a914d6ab498db8468ea50052a0fb85e755f53e8712b588ac00000000",
		UTXOHeights: []uint32{477526},
	},
	{
		TxID:        "7be4fa421844154ec4105894def768a8bcd80da25792947d585274ce38c07105",
		BlockHeight: 632099,
		ExtendedTx:  "020000000000000000ef023f6c667203b47ce2fed8c8bcc78d764c39da9c0094f1a49074e05f66910e9c44000000006b4c69522102401d5481712745cf7ada12b7251c85ca5f1b8b6c859c7e81b8002a85b0f36d3c21039d8b1e461715ddd4d10806125be8592e6f48fb69e4c31699ce6750da1c9eaeb32103af3b35d4ad547fd1ce102bbd5cce36de2277723796f1b4001ec0ea6a1db6474053aeffffffffa73018250000000017a91413402e079464ec2a85e5a613732c78b0613fcc65873f6c667203b47ce2fed8c8bcc78d764c39da9c0094f1a49074e05f66910e9c44010000006b4c69522102401d5481712745cf7ada12b7251c85ca5f1b8b6c859c7e81b8002a85b0f36d3c21039d8b1e461715ddd4d10806125be8592e6f48fb69e4c31699ce6750da1c9eaeb32103af3b35d4ad547fd1ce102bbd5cce36de2277723796f1b4001ec0ea6a1db6474053aeffffffff34b82f000000000017a91413402e079464ec2a85e5a613732c78b0613fcc65870187e74725000000001976a9141be3d23725148a90807ee6df191bcdfcf083a3b288ac00000000",
		UTXOHeights: []uint32{631924, 631924},
	},
}

// To run this test, make sure GoBDK is installed and environment for it is set
// Then run
//
//	go clean -testcache &&go test -v -run Test_ScriptVerificationGoBDK ./services/validator/...
func Test_ScriptVerificationGoBDK(t *testing.T) {
	verifier := newScriptVerifierGoBDK(ulogger.TestLogger{}, settings.NewPolicySettings(), &chaincfg.MainNetParams)

	for _, test := range testTxs {
		tx, errTx := bt.NewTxFromString(test.ExtendedTx)
		require.NoError(t, errTx)

		err := verifier.VerifyScript(tx, test.BlockHeight, true, test.UTXOHeights)
		require.NoError(t, err, fmt.Sprintf("Failed with TxID %v", test.TxID))
	}
}

func Test_ScriptVerificationGoBDK_invalid(t *testing.T) {
	verifier := newScriptVerifierGoBDK(ulogger.TestLogger{}, settings.NewPolicySettings(), &chaincfg.MainNetParams)

	for _, test := range testTxs {
		tx, errTx := bt.NewTxFromString(test.ExtendedTx)
		require.NoError(t, errTx)

		// introduce a small change, that messes with the validation
		binUnlockingScript := tx.Inputs[0].UnlockingScript.Bytes()
		binUnlockingScript = append(binUnlockingScript, byte(0x10))
		binUnlockingScript[0] = 0x00
		modifiedLockingScript := bscript.NewFromBytes(binUnlockingScript)
		tx.Inputs[0].UnlockingScript = modifiedLockingScript

		err := verifier.VerifyScript(tx, test.BlockHeight, true, test.UTXOHeights)
		require.Error(t, err, fmt.Sprintf("Failed tx with TXID %v", test.TxID))
	}
}

func Test_Uint2Int(t *testing.T) {
	tests := []struct {
		name     string
		input    []uint32
		expected []int32
	}{
		{
			name:     "empty slice",
			input:    []uint32{},
			expected: []int32{},
		},
		{
			name:     "positive numbers",
			input:    []uint32{0, 1, 2},
			expected: []int32{0, 1, 2},
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result, err := uint2int(tt.input)

			if !reflect.DeepEqual(result, tt.expected) {
				t.Errorf("uint2int(%v) = %v; want %v", tt.input, result, tt.expected)
			}

			assert.NoError(t, err)
		})
	}
}
